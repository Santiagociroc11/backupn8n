{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-01-19T11:00:42.653Z",
    "createdAt": "2026-01-19T11:00:42.653Z",
    "versionId": "08bafa64-7d4b-44fa-939d-3b2d306d9ee1",
    "workflowId": "U01F8eeHGvs3RI3z",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "terence-org-registroblack25",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -736,
          -272
        ],
        "id": "fa3b6ec2-359a-4a0f-8b4c-2bd351e6dd11",
        "name": "REGISTRO",
        "webhookId": "f5b93a3c-70fd-4d29-8008-1b8645c974cb"
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "={{ $json }}",
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -304,
          -176
        ],
        "id": "ab4ef615-05ef-49c9-b384-c9b784b595b1",
        "name": "Edit Fields"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "eb31eaf1-7f83-4773-a663-4213a227c9e8",
                "leftValue": "={{ $json }}",
                "rightValue": "",
                "operator": {
                  "type": "object",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "b08d0b66-7f20-4cbd-b051-f565f8c2dcef",
        "name": "If",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          144,
          -176
        ]
      },
      {
        "parameters": {
          "mode": "chooseBranch"
        },
        "id": "a0a6ca24-4c6e-4ffc-b329-51643bc3c842",
        "name": "Merge",
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          368,
          -272
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "8a258913-16e5-4c77-bc40-13e5d18f740f",
                "name": "ip",
                "value": "={{ $json.body.data.contact.ip }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -288,
          -384
        ],
        "id": "8955438f-2114-4dcc-9d02-7f911b0b44c9",
        "name": "Edit Fields2"
      },
      {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineAll",
          "options": {}
        },
        "id": "a9f92203-32a1-4537-8c98-a4eac8fa9b50",
        "name": "Merge2",
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          144,
          -368
        ]
      },
      {
        "parameters": {
          "url": "=http://ip-api.com/json/{{ $json.ip }}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          -64,
          -384
        ],
        "id": "42aa87f3-08c1-49ce-8e3d-dc91856a15a8",
        "name": "HTTP Request",
        "retryOnFail": true,
        "maxTries": 5,
        "waitBetweenTries": 5000
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.manychat.com/fb/subscriber/createSubscriber",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Authorization",
                "value": "Bearer 288702267651723:f96a1f26344892df99c98292741de8c9"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Accept",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"first_name\": \"{{ $('Insert documents').item.json.whatsapp }}\",\n  \"whatsapp_phone\": \"{{ $('Insert documents').item.json.whatsapp }}\"\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          1280,
          -112
        ],
        "id": "76680ce5-1a9e-4ee5-b3a4-febf8b62bf87",
        "name": "HTTP Request4",
        "retryOnFail": true,
        "waitBetweenTries": 5000,
        "maxTries": 5,
        "disabled": true,
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineAll",
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          1680,
          -32
        ],
        "id": "45ef1258-6a3d-4367-bb20-d04fb18db0ee",
        "name": "Merge5",
        "disabled": true
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "17104ede-50c0-4ff6-b16b-5ec89d177da7",
                "name": "id_manychat",
                "value": "={{ $json.data.id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          1488,
          -128
        ],
        "id": "45239cf5-515a-4819-844d-3abec34b5acd",
        "name": "Edit Fields5",
        "disabled": true
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "86552321-4bbc-4aa5-afc7-5ce6278c72d2",
                "name": "CORREO",
                "value": "={{ $json.email }}",
                "type": "string"
              },
              {
                "id": "ef1606bf-68e5-4717-a225-708529dcad05",
                "name": "WHATSAPP",
                "value": "={{ $json.whatsapp }}",
                "type": "string"
              },
              {
                "id": "0f13f81b-905a-4e1e-815c-3bcb4932bb77",
                "name": "CAMPA칌A",
                "value": "={{ $json.utmCampaign }}",
                "type": "string"
              },
              {
                "id": "b008676e-7f3b-46eb-9c3f-13f4757b8977",
                "name": "PLATAFORMA",
                "value": "={{ $json.utmSource }}",
                "type": "string"
              },
              {
                "id": "0fa1b73e-3467-49e9-af06-7a4d94901a7b",
                "name": "SEGMENTACION",
                "value": "={{ $json.utmMedium }}",
                "type": "string"
              },
              {
                "id": "50bd88a7-ded2-46df-a377-6c529be00917",
                "name": "ANUNCIO",
                "value": "={{ $json.utmContent }}",
                "type": "string"
              },
              {
                "id": "4747c5a6-da7e-4da9-9a86-fe23003d5adf",
                "name": "PAIS",
                "value": "={{ $json.country }}",
                "type": "string"
              },
              {
                "id": "3df6352b-6489-4d01-9e8e-ad90cc547eda",
                "name": "ID",
                "value": "={{ $json.id.toString() }}",
                "type": "string"
              },
              {
                "id": "c3adebcf-1f39-46ce-9548-b1243262ba2d",
                "name": "FECHA REGISTRO",
                "value": "={{ $now.format('yyyy-MM-dd') }}",
                "type": "string"
              },
              {
                "id": "d42a68f2-323f-4337-b37f-ec1b9a9e65c4",
                "name": "HORA",
                "value": "={{ $now.format('HH:mm:ss:s') }}",
                "type": "string"
              },
              {
                "id": "ba1e8726-72dc-4603-996c-949c755897eb",
                "name": "AD_ID",
                "value": "={{ $json.adid }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          848,
          -880
        ],
        "id": "4d6593e5-a7ec-482f-81d6-1c82df3e285d",
        "name": "Edit Fields6"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "b3101ba6-b04a-40da-86e8-04bb9fabd5d7",
                "leftValue": "={{ $('Merge5').item.json.existe }}",
                "rightValue": "si",
                "operator": {
                  "type": "string",
                  "operation": "notExists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          2032,
          -32
        ],
        "id": "b294f998-fdab-4a70-a624-cb089c338ba8",
        "name": "existe?",
        "disabled": true
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "bdbedabd-650a-4c77-aafe-61f48231f405",
                "leftValue": "={{ $json.data[0].id }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          1072,
          -208
        ],
        "id": "cc232fad-cf05-4763-bb7a-cf8a117caa43",
        "name": "existe en manychat?",
        "disabled": true
      },
      {
        "parameters": {
          "operation": "findOneAndUpdate",
          "collection": "TD-BLACK25",
          "updateKey": "_id",
          "fields": "=id_manychat",
          "options": {}
        },
        "id": "420e9cb8-f7fb-4dd0-81be-b88e5e932a54",
        "name": "guardar id MANYCHAT",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1.1,
        "position": [
          1856,
          -32
        ],
        "credentials": {
          "mongoDb": {
            "id": "NAmnhvdIS8ryFTBw",
            "name": "WIN+2-RECUPERA"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.manychat.com/fb/sending/sendFlow",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Authorization",
                "value": "Bearer 288702267651723:f96a1f26344892df99c98292741de8c9"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Accept",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"subscriber_id\": {{ $json.id_manychat }},\n  \"flow_ns\": \"content20251001044048_260950\"\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          2256,
          -48
        ],
        "id": "81a12f79-249c-40f1-bde9-c02668faf330",
        "name": "ENVIAR FLUJO BV",
        "retryOnFail": true,
        "waitBetweenTries": 5000,
        "maxTries": 5,
        "disabled": true,
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "url": "https://api.manychat.com/fb/subscriber/findByName",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "name",
                "value": "={{ $json.whatsapp }}"
              }
            ]
          },
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Authorization",
                "value": "Bearer 288702267651723:f96a1f26344892df99c98292741de8c9"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Accept",
                "value": "application/json"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          848,
          -192
        ],
        "id": "d17d1b15-e913-4488-9500-d3f3667e5648",
        "name": "HTTP Request7",
        "retryOnFail": true,
        "waitBetweenTries": 5000,
        "maxTries": 5,
        "disabled": true,
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "17104ede-50c0-4ff6-b16b-5ec89d177da7",
                "name": "id_manychat",
                "value": "={{ $json.data[0].id }}",
                "type": "string"
              },
              {
                "id": "8040badb-7f75-4766-b6ef-8e74c88bc480",
                "name": "existe",
                "value": "si",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          1360,
          -240
        ],
        "id": "b055e08a-3f9e-4460-848b-3f86ebd7fd65",
        "name": "Edit Fields8",
        "disabled": true
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "7f3e8099-ae55-4534-a5be-217d413c0ff2",
                "leftValue": "={{ $json }}",
                "rightValue": "",
                "operator": {
                  "type": "object",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          1280,
          -784
        ],
        "id": "53389bfd-ca91-4453-9391-aac8c21da800",
        "name": "If5"
      },
      {
        "parameters": {
          "mode": "chooseBranch"
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          1504,
          -864
        ],
        "id": "650e3ea9-5886-4158-af26-1505dc7078ad",
        "name": "Merge7"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.flodesk.com/v1/subscribers",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "User-Agent",
                "value": "n8n"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n    \"email\": \"{{ $('Insert documents').item.json.email }}\",\n    \"segment_ids\": [\n       \"692011114cce17fe00713b9b\"\n    ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          1312,
          -608
        ],
        "id": "7c4596ad-9179-4fa1-b108-f038deb3c96b",
        "name": "INSERTA FLODESK1",
        "retryOnFail": true,
        "maxTries": 5,
        "waitBetweenTries": 5000,
        "credentials": {
          "httpHeaderAuth": {
            "id": "JzZ2saBcDbEsbcOC",
            "name": "API FLODESK N8N GERSSON"
          }
        },
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "ff9f56d5-3bdc-45e2-b7f3-5fec484a6f1c",
                "leftValue": "={{ $json.error.status }}",
                "rightValue": 404,
                "operator": {
                  "type": "number",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          1088,
          -512
        ],
        "id": "ddec21a8-a88a-4910-a262-bf67777d9e3f",
        "name": "EXISTE FLODESK?1"
      },
      {
        "parameters": {
          "url": "=https://api.flodesk.com/v1/subscribers/{{ $json.email }}",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "User-Agent",
                "value": "n8n"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          864,
          -512
        ],
        "id": "aa386c35-1413-4bd5-a765-107e494583c2",
        "name": "BUSQUEDA EN FLODESK",
        "retryOnFail": false,
        "maxTries": 5,
        "waitBetweenTries": 5000,
        "credentials": {
          "httpHeaderAuth": {
            "id": "JzZ2saBcDbEsbcOC",
            "name": "API FLODESK N8N GERSSON"
          }
        },
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "operation": "select",
          "table": {
            "__rl": true,
            "value": "TERENCE-BLACK25-ORG",
            "mode": "list",
            "cachedResultName": "TERENCE-BLACK25-ORG"
          },
          "returnAll": true,
          "where": {
            "values": [
              {
                "column": "ID",
                "condition": "LIKE",
                "value": "={{ $json.ID }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.mySql",
        "typeVersion": 2.4,
        "position": [
          1056,
          -784
        ],
        "id": "0457d252-5070-4b66-a99b-aeea0a01a4da",
        "name": "Select rows from a table",
        "alwaysOutputData": true,
        "credentials": {
          "mySql": {
            "id": "n8fCALXWnGdmJkBN",
            "name": "CAPTACIONES"
          }
        }
      },
      {
        "parameters": {
          "table": {
            "__rl": true,
            "value": "TERENCE-BLACK25-ORG",
            "mode": "list",
            "cachedResultName": "TERENCE-BLACK25-ORG"
          },
          "dataMode": "defineBelow",
          "valuesToSend": {
            "values": [
              {
                "column": "FECHA_REGISTRO",
                "value": "={{ $json[\"FECHA REGISTRO\"] }}"
              },
              {
                "column": "HORA_REGISTRO",
                "value": "={{ $json.HORA }}"
              },
              {
                "column": "CORREO",
                "value": "={{ $json.CORREO }}"
              },
              {
                "column": "WHATSAPP",
                "value": "={{ $json.WHATSAPP }}"
              },
              {
                "column": "PLATAFORMA",
                "value": "={{ $json.PLATAFORMA }}"
              },
              {
                "column": "SEGMENTACION",
                "value": "={{ $json.SEGMENTACION }}"
              },
              {
                "column": "ANUNCIO",
                "value": "={{ $json.ANUNCIO }}"
              },
              {
                "column": "CAMPA칌A",
                "value": "={{ $json[\"CAMPA칌A\"] }}"
              },
              {
                "column": "PAIS",
                "value": "={{ $json.PAIS }}"
              },
              {
                "column": "ID",
                "value": "={{ $json.ID }}"
              },
              {
                "column": "AD_ID",
                "value": "={{ $json.AD_ID }}"
              }
            ]
          },
          "options": {
            "detailedOutput": true
          }
        },
        "type": "n8n-nodes-base.mySql",
        "typeVersion": 2.4,
        "position": [
          1728,
          -864
        ],
        "id": "63626ac9-2a44-4d24-b755-82d9c4626195",
        "name": "Insert rows in a table",
        "credentials": {
          "mySql": {
            "id": "n8fCALXWnGdmJkBN",
            "name": "CAPTACIONES"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.flodesk.com/v1/subscribers/{{ $json.id }}/segments",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "User-Agent",
                "value": "n8n"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n    \"segment_ids\": [\n       \"692011114cce17fe00713b9b\"\n    ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          1312,
          -416
        ],
        "id": "f6acd3dd-7541-4f9a-bfb1-bd41abb0559c",
        "name": "MOVER A SEGMENT",
        "retryOnFail": true,
        "maxTries": 5,
        "waitBetweenTries": 5000,
        "credentials": {
          "httpHeaderAuth": {
            "id": "JzZ2saBcDbEsbcOC",
            "name": "API FLODESK N8N GERSSON"
          }
        },
        "onError": "continueRegularOutput"
      },
      {
        "parameters": {
          "collection": "=TERENCE-BLACK25-ORG",
          "options": {
            "limit": 1
          },
          "query": "={\"whatsapp\": \"{{ $json.whatsapp }}\", \"email\": \"{{$json.email}}\"}"
        },
        "id": "b2977e00-d5ab-4159-8f1e-f5d01bb34e93",
        "name": "Find documents",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1.1,
        "position": [
          -80,
          -176
        ],
        "alwaysOutputData": true,
        "retryOnFail": true,
        "waitBetweenTries": 5000,
        "credentials": {
          "mongoDb": {
            "id": "HkT2a4PLvV4ZpWyr",
            "name": "BD TERENCE"
          }
        }
      },
      {
        "parameters": {
          "operation": "insert",
          "collection": "TERENCE-BLACK25-ORG",
          "fields": "=ip,country,city,zip,regionName,timezone,email,whatsapp,utmCampaign,utmSource,utmMedium,utmContent,utmTerm,adid,tiempoRegistro",
          "options": {}
        },
        "id": "1113040d-d646-4b23-9b53-7439a7d88614",
        "name": "Insert documents",
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1.1,
        "position": [
          592,
          -272
        ],
        "credentials": {
          "mongoDb": {
            "id": "HkT2a4PLvV4ZpWyr",
            "name": "BD TERENCE"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Iteramos sobre todos los elementos de entrada\nreturn $input.all().map(item => {\n  \n  // Accedemos a la estructura del cuerpo del webhook\n  const body = item.json.body;\n  const data = body.data;\n  const contact = data.contact;\n\n  // Inicializamos variables\n  let utmSource = null;\n  let utmCampaign = null;\n  let utmMedium = null;\n  let utmContent = null;\n  let utmTerm = null;\n  let adid = null; // Usamos 'adid' para coincidir con tu snippet\n\n  // L칩gica para extraer las UTMs de la 'source_url'\n  if (data.source_url) {\n    try {\n      const urlObj = new URL(data.source_url);\n      const params = urlObj.searchParams;\n\n      // Extracci칩n est치ndar de UTMs\n      utmSource = params.get('utm_source');\n      utmCampaign = params.get('utm_campaign');\n      utmMedium = params.get('utm_medium');\n      utmContent = params.get('utm_content');\n      utmTerm = params.get('utm_term');\n      adid = params.get('ad_id');\n\n    } catch (error) {\n      console.log('Error parseando URL:', error);\n    }\n  }\n\n  // Retornamos el objeto con las claves que usas\n  return {\n    json: {\n      ip: contact.ip,\n      email: contact.email,\n      whatsapp: contact.fields ? contact.fields.phone_number : null,\n      utmCampaign: utmCampaign || \"-\", // Agregamos fallback a \"-\" si prefieres ese formato\n      utmSource: utmSource || \"-\",\n      utmMedium: utmMedium || \"-\",\n      utmContent: utmContent || \"-\",\n      utmTerm: utmTerm || \"-\",\n      adid: adid || \"-\", // El ID extra칤do (ya sea por par치metro o por split)\n      tiempoRegistro: body.created_at\n    }\n  };\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -496,
          -176
        ],
        "id": "05cac854-d70d-417b-b5f8-2ddb99e9a8ac",
        "name": "Code in JavaScript"
      }
    ],
    "connections": {
      "REGISTRO": {
        "main": [
          [
            {
              "node": "Edit Fields2",
              "type": "main",
              "index": 0
            },
            {
              "node": "Code in JavaScript",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "Find documents",
              "type": "main",
              "index": 0
            },
            {
              "node": "Merge2",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge": {
        "main": [
          [
            {
              "node": "Insert documents",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields2": {
        "main": [
          [
            {
              "node": "HTTP Request",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge2": {
        "main": [
          [
            {
              "node": "Merge",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request": {
        "main": [
          [
            {
              "node": "Merge2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request4": {
        "main": [
          [
            {
              "node": "Edit Fields5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge5": {
        "main": [
          [
            {
              "node": "guardar id MANYCHAT",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields5": {
        "main": [
          [
            {
              "node": "Merge5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields6": {
        "main": [
          [
            {
              "node": "Select rows from a table",
              "type": "main",
              "index": 0
            },
            {
              "node": "Merge7",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "existe?": {
        "main": [
          [
            {
              "node": "ENVIAR FLUJO BV",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "existe en manychat?": {
        "main": [
          [
            {
              "node": "Edit Fields8",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "HTTP Request4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "guardar id MANYCHAT": {
        "main": [
          [
            {
              "node": "existe?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request7": {
        "main": [
          [
            {
              "node": "existe en manychat?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields8": {
        "main": [
          [
            {
              "node": "Merge5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If5": {
        "main": [
          [
            {
              "node": "Merge7",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge7": {
        "main": [
          [
            {
              "node": "Insert rows in a table",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "EXISTE FLODESK?1": {
        "main": [
          [
            {
              "node": "INSERTA FLODESK1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "MOVER A SEGMENT",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "BUSQUEDA EN FLODESK": {
        "main": [
          [
            {
              "node": "EXISTE FLODESK?1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Select rows from a table": {
        "main": [
          [
            {
              "node": "If5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Find documents": {
        "main": [
          [
            {
              "node": "If",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insert documents": {
        "main": [
          [
            {
              "node": "Merge5",
              "type": "main",
              "index": 1
            },
            {
              "node": "Edit Fields6",
              "type": "main",
              "index": 0
            },
            {
              "node": "HTTP Request7",
              "type": "main",
              "index": 0
            },
            {
              "node": "BUSQUEDA EN FLODESK",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript": {
        "main": [
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "system migration",
    "name": null,
    "description": null,
    "autosaved": false
  },
  "activeVersionId": "08bafa64-7d4b-44fa-939d-3b2d306d9ee1",
  "connections": {
    "REGISTRO": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Find documents",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Insert documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request4": {
      "main": [
        [
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge5": {
      "main": [
        [
          {
            "node": "guardar id MANYCHAT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields6": {
      "main": [
        [
          {
            "node": "Select rows from a table",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "existe?": {
      "main": [
        [
          {
            "node": "ENVIAR FLUJO BV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "existe en manychat?": {
      "main": [
        [
          {
            "node": "Edit Fields8",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "guardar id MANYCHAT": {
      "main": [
        [
          {
            "node": "existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request7": {
      "main": [
        [
          {
            "node": "existe en manychat?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields8": {
      "main": [
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge7": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EXISTE FLODESK?1": {
      "main": [
        [
          {
            "node": "INSERTA FLODESK1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "MOVER A SEGMENT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BUSQUEDA EN FLODESK": {
      "main": [
        [
          {
            "node": "EXISTE FLODESK?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select rows from a table": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find documents": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert documents": {
      "main": [
        [
          {
            "node": "Merge5",
            "type": "main",
            "index": 1
          },
          {
            "node": "Edit Fields6",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Request7",
            "type": "main",
            "index": 0
          },
          {
            "node": "BUSQUEDA EN FLODESK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-11-21T21:00:45.458Z",
  "id": "U01F8eeHGvs3RI3z",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "游릭 [TERENCE-BLACK2025] CAPTURA ORG- REGISTRO Y ENCUESTAS",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "terence-org-registroblack25",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -736,
        -272
      ],
      "id": "fa3b6ec2-359a-4a0f-8b4c-2bd351e6dd11",
      "name": "REGISTRO",
      "webhookId": "f5b93a3c-70fd-4d29-8008-1b8645c974cb"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -304,
        -176
      ],
      "id": "ab4ef615-05ef-49c9-b384-c9b784b595b1",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "eb31eaf1-7f83-4773-a663-4213a227c9e8",
              "leftValue": "={{ $json }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "b08d0b66-7f20-4cbd-b051-f565f8c2dcef",
      "name": "If",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        144,
        -176
      ]
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "id": "a0a6ca24-4c6e-4ffc-b329-51643bc3c842",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        368,
        -272
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8a258913-16e5-4c77-bc40-13e5d18f740f",
              "name": "ip",
              "value": "={{ $json.body.data.contact.ip }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -288,
        -384
      ],
      "id": "8955438f-2114-4dcc-9d02-7f911b0b44c9",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "id": "a9f92203-32a1-4537-8c98-a4eac8fa9b50",
      "name": "Merge2",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        144,
        -368
      ]
    },
    {
      "parameters": {
        "url": "=http://ip-api.com/json/{{ $json.ip }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -64,
        -384
      ],
      "id": "42aa87f3-08c1-49ce-8e3d-dc91856a15a8",
      "name": "HTTP Request",
      "retryOnFail": true,
      "maxTries": 5,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.manychat.com/fb/subscriber/createSubscriber",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 288702267651723:f96a1f26344892df99c98292741de8c9"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"first_name\": \"{{ $('Insert documents').item.json.whatsapp }}\",\n  \"whatsapp_phone\": \"{{ $('Insert documents').item.json.whatsapp }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1280,
        -112
      ],
      "id": "76680ce5-1a9e-4ee5-b3a4-febf8b62bf87",
      "name": "HTTP Request4",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "maxTries": 5,
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1680,
        -32
      ],
      "id": "45ef1258-6a3d-4367-bb20-d04fb18db0ee",
      "name": "Merge5",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "17104ede-50c0-4ff6-b16b-5ec89d177da7",
              "name": "id_manychat",
              "value": "={{ $json.data.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1488,
        -128
      ],
      "id": "45239cf5-515a-4819-844d-3abec34b5acd",
      "name": "Edit Fields5",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "86552321-4bbc-4aa5-afc7-5ce6278c72d2",
              "name": "CORREO",
              "value": "={{ $json.email }}",
              "type": "string"
            },
            {
              "id": "ef1606bf-68e5-4717-a225-708529dcad05",
              "name": "WHATSAPP",
              "value": "={{ $json.whatsapp }}",
              "type": "string"
            },
            {
              "id": "0f13f81b-905a-4e1e-815c-3bcb4932bb77",
              "name": "CAMPA칌A",
              "value": "={{ $json.utmCampaign }}",
              "type": "string"
            },
            {
              "id": "b008676e-7f3b-46eb-9c3f-13f4757b8977",
              "name": "PLATAFORMA",
              "value": "={{ $json.utmSource }}",
              "type": "string"
            },
            {
              "id": "0fa1b73e-3467-49e9-af06-7a4d94901a7b",
              "name": "SEGMENTACION",
              "value": "={{ $json.utmMedium }}",
              "type": "string"
            },
            {
              "id": "50bd88a7-ded2-46df-a377-6c529be00917",
              "name": "ANUNCIO",
              "value": "={{ $json.utmContent }}",
              "type": "string"
            },
            {
              "id": "4747c5a6-da7e-4da9-9a86-fe23003d5adf",
              "name": "PAIS",
              "value": "={{ $json.country }}",
              "type": "string"
            },
            {
              "id": "3df6352b-6489-4d01-9e8e-ad90cc547eda",
              "name": "ID",
              "value": "={{ $json.id.toString() }}",
              "type": "string"
            },
            {
              "id": "c3adebcf-1f39-46ce-9548-b1243262ba2d",
              "name": "FECHA REGISTRO",
              "value": "={{ $now.format('yyyy-MM-dd') }}",
              "type": "string"
            },
            {
              "id": "d42a68f2-323f-4337-b37f-ec1b9a9e65c4",
              "name": "HORA",
              "value": "={{ $now.format('HH:mm:ss:s') }}",
              "type": "string"
            },
            {
              "id": "ba1e8726-72dc-4603-996c-949c755897eb",
              "name": "AD_ID",
              "value": "={{ $json.adid }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        848,
        -880
      ],
      "id": "4d6593e5-a7ec-482f-81d6-1c82df3e285d",
      "name": "Edit Fields6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b3101ba6-b04a-40da-86e8-04bb9fabd5d7",
              "leftValue": "={{ $('Merge5').item.json.existe }}",
              "rightValue": "si",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2032,
        -32
      ],
      "id": "b294f998-fdab-4a70-a624-cb089c338ba8",
      "name": "existe?",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "bdbedabd-650a-4c77-aafe-61f48231f405",
              "leftValue": "={{ $json.data[0].id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1072,
        -208
      ],
      "id": "cc232fad-cf05-4763-bb7a-cf8a117caa43",
      "name": "existe en manychat?",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "findOneAndUpdate",
        "collection": "TD-BLACK25",
        "updateKey": "_id",
        "fields": "=id_manychat",
        "options": {}
      },
      "id": "420e9cb8-f7fb-4dd0-81be-b88e5e932a54",
      "name": "guardar id MANYCHAT",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        1856,
        -32
      ],
      "credentials": {
        "mongoDb": {
          "id": "NAmnhvdIS8ryFTBw",
          "name": "WIN+2-RECUPERA"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.manychat.com/fb/sending/sendFlow",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 288702267651723:f96a1f26344892df99c98292741de8c9"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"subscriber_id\": {{ $json.id_manychat }},\n  \"flow_ns\": \"content20251001044048_260950\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2256,
        -48
      ],
      "id": "81a12f79-249c-40f1-bde9-c02668faf330",
      "name": "ENVIAR FLUJO BV",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "maxTries": 5,
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "url": "https://api.manychat.com/fb/subscriber/findByName",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "name",
              "value": "={{ $json.whatsapp }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 288702267651723:f96a1f26344892df99c98292741de8c9"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        848,
        -192
      ],
      "id": "d17d1b15-e913-4488-9500-d3f3667e5648",
      "name": "HTTP Request7",
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "maxTries": 5,
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "17104ede-50c0-4ff6-b16b-5ec89d177da7",
              "name": "id_manychat",
              "value": "={{ $json.data[0].id }}",
              "type": "string"
            },
            {
              "id": "8040badb-7f75-4766-b6ef-8e74c88bc480",
              "name": "existe",
              "value": "si",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1360,
        -240
      ],
      "id": "b055e08a-3f9e-4460-848b-3f86ebd7fd65",
      "name": "Edit Fields8",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7f3e8099-ae55-4534-a5be-217d413c0ff2",
              "leftValue": "={{ $json }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1280,
        -784
      ],
      "id": "53389bfd-ca91-4453-9391-aac8c21da800",
      "name": "If5"
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1504,
        -864
      ],
      "id": "650e3ea9-5886-4158-af26-1505dc7078ad",
      "name": "Merge7"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.flodesk.com/v1/subscribers",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "n8n"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"email\": \"{{ $('Insert documents').item.json.email }}\",\n    \"segment_ids\": [\n       \"692011114cce17fe00713b9b\"\n    ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1312,
        -608
      ],
      "id": "7c4596ad-9179-4fa1-b108-f038deb3c96b",
      "name": "INSERTA FLODESK1",
      "retryOnFail": true,
      "maxTries": 5,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "JzZ2saBcDbEsbcOC",
          "name": "API FLODESK N8N GERSSON"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff9f56d5-3bdc-45e2-b7f3-5fec484a6f1c",
              "leftValue": "={{ $json.error.status }}",
              "rightValue": 404,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1088,
        -512
      ],
      "id": "ddec21a8-a88a-4910-a262-bf67777d9e3f",
      "name": "EXISTE FLODESK?1"
    },
    {
      "parameters": {
        "url": "=https://api.flodesk.com/v1/subscribers/{{ $json.email }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "n8n"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        864,
        -512
      ],
      "id": "aa386c35-1413-4bd5-a765-107e494583c2",
      "name": "BUSQUEDA EN FLODESK",
      "retryOnFail": false,
      "maxTries": 5,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "JzZ2saBcDbEsbcOC",
          "name": "API FLODESK N8N GERSSON"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "TERENCE-BLACK25-ORG",
          "mode": "list",
          "cachedResultName": "TERENCE-BLACK25-ORG"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "ID",
              "condition": "LIKE",
              "value": "={{ $json.ID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1056,
        -784
      ],
      "id": "0457d252-5070-4b66-a99b-aeea0a01a4da",
      "name": "Select rows from a table",
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "n8fCALXWnGdmJkBN",
          "name": "CAPTACIONES"
        }
      }
    },
    {
      "parameters": {
        "table": {
          "__rl": true,
          "value": "TERENCE-BLACK25-ORG",
          "mode": "list",
          "cachedResultName": "TERENCE-BLACK25-ORG"
        },
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "FECHA_REGISTRO",
              "value": "={{ $json[\"FECHA REGISTRO\"] }}"
            },
            {
              "column": "HORA_REGISTRO",
              "value": "={{ $json.HORA }}"
            },
            {
              "column": "CORREO",
              "value": "={{ $json.CORREO }}"
            },
            {
              "column": "WHATSAPP",
              "value": "={{ $json.WHATSAPP }}"
            },
            {
              "column": "PLATAFORMA",
              "value": "={{ $json.PLATAFORMA }}"
            },
            {
              "column": "SEGMENTACION",
              "value": "={{ $json.SEGMENTACION }}"
            },
            {
              "column": "ANUNCIO",
              "value": "={{ $json.ANUNCIO }}"
            },
            {
              "column": "CAMPA칌A",
              "value": "={{ $json[\"CAMPA칌A\"] }}"
            },
            {
              "column": "PAIS",
              "value": "={{ $json.PAIS }}"
            },
            {
              "column": "ID",
              "value": "={{ $json.ID }}"
            },
            {
              "column": "AD_ID",
              "value": "={{ $json.AD_ID }}"
            }
          ]
        },
        "options": {
          "detailedOutput": true
        }
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1728,
        -864
      ],
      "id": "63626ac9-2a44-4d24-b755-82d9c4626195",
      "name": "Insert rows in a table",
      "credentials": {
        "mySql": {
          "id": "n8fCALXWnGdmJkBN",
          "name": "CAPTACIONES"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.flodesk.com/v1/subscribers/{{ $json.id }}/segments",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "n8n"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"segment_ids\": [\n       \"692011114cce17fe00713b9b\"\n    ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1312,
        -416
      ],
      "id": "f6acd3dd-7541-4f9a-bfb1-bd41abb0559c",
      "name": "MOVER A SEGMENT",
      "retryOnFail": true,
      "maxTries": 5,
      "waitBetweenTries": 5000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "JzZ2saBcDbEsbcOC",
          "name": "API FLODESK N8N GERSSON"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "collection": "=TERENCE-BLACK25-ORG",
        "options": {
          "limit": 1
        },
        "query": "={\"whatsapp\": \"{{ $json.whatsapp }}\", \"email\": \"{{$json.email}}\"}"
      },
      "id": "b2977e00-d5ab-4159-8f1e-f5d01bb34e93",
      "name": "Find documents",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        -80,
        -176
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "waitBetweenTries": 5000,
      "credentials": {
        "mongoDb": {
          "id": "HkT2a4PLvV4ZpWyr",
          "name": "BD TERENCE"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "TERENCE-BLACK25-ORG",
        "fields": "=ip,country,city,zip,regionName,timezone,email,whatsapp,utmCampaign,utmSource,utmMedium,utmContent,utmTerm,adid,tiempoRegistro",
        "options": {}
      },
      "id": "1113040d-d646-4b23-9b53-7439a7d88614",
      "name": "Insert documents",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        592,
        -272
      ],
      "credentials": {
        "mongoDb": {
          "id": "HkT2a4PLvV4ZpWyr",
          "name": "BD TERENCE"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Iteramos sobre todos los elementos de entrada\nreturn $input.all().map(item => {\n  \n  // Accedemos a la estructura del cuerpo del webhook\n  const body = item.json.body;\n  const data = body.data;\n  const contact = data.contact;\n\n  // Inicializamos variables\n  let utmSource = null;\n  let utmCampaign = null;\n  let utmMedium = null;\n  let utmContent = null;\n  let utmTerm = null;\n  let adid = null; // Usamos 'adid' para coincidir con tu snippet\n\n  // L칩gica para extraer las UTMs de la 'source_url'\n  if (data.source_url) {\n    try {\n      const urlObj = new URL(data.source_url);\n      const params = urlObj.searchParams;\n\n      // Extracci칩n est치ndar de UTMs\n      utmSource = params.get('utm_source');\n      utmCampaign = params.get('utm_campaign');\n      utmMedium = params.get('utm_medium');\n      utmContent = params.get('utm_content');\n      utmTerm = params.get('utm_term');\n      adid = params.get('ad_id');\n\n    } catch (error) {\n      console.log('Error parseando URL:', error);\n    }\n  }\n\n  // Retornamos el objeto con las claves que usas\n  return {\n    json: {\n      ip: contact.ip,\n      email: contact.email,\n      whatsapp: contact.fields ? contact.fields.phone_number : null,\n      utmCampaign: utmCampaign || \"-\", // Agregamos fallback a \"-\" si prefieres ese formato\n      utmSource: utmSource || \"-\",\n      utmMedium: utmMedium || \"-\",\n      utmContent: utmContent || \"-\",\n      utmTerm: utmTerm || \"-\",\n      adid: adid || \"-\", // El ID extra칤do (ya sea por par치metro o por split)\n      tiempoRegistro: body.created_at\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        -176
      ],
      "id": "05cac854-d70d-417b-b5f8-2ddb99e9a8ac",
      "name": "Code in JavaScript"
    }
  ],
  "pinData": {
    "REGISTRO": [
      {
        "json": {
          "headers": {
            "host": "n8n.automscc.com",
            "user-agent": "Symfony",
            "content-length": "736",
            "accept": "application/json",
            "accept-charset": "ISO-8859-1,utf-8;q=0.7,*;q=0.7",
            "accept-encoding": "gzip, br",
            "accept-language": "en-us,en;q=0.5",
            "cdn-loop": "cloudflare; loops=1",
            "cf-connecting-ip": "185.236.142.1",
            "cf-ipcountry": "IE",
            "cf-ray": "9a1e31a5efd0c209-DUB",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "content-type": "application/json",
            "x-forwarded-for": "185.236.142.1, 162.158.6.87",
            "x-forwarded-host": "n8n.automscc.com",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "3a6a6ec7bbe4",
            "x-real-ip": "162.158.6.87"
          },
          "params": {},
          "query": {},
          "body": {
            "type": "contact.optin.completed",
            "data": {
              "funnel_step": {
                "id": 21531758,
                "name": "P치gina de Registro Black | Terence",
                "type": "squeeze",
                "funnel": {
                  "id": 6502644,
                  "name": "P치gina de venta Blanck Friday - Terence Crudo"
                }
              },
              "contact": {
                "referred_by_contact_id": null,
                "referred_by_contact_email": null,
                "id": 377745235,
                "email": "santiagociiro12@gmail.com",
                "fields": {
                  "phone_number": "573136298562"
                },
                "ip": "181.235.103.43"
              },
              "source_url": "https://www.terencecrudo.online/registro?utm_source={{placement}}&utm_campaign={{campaign.name}}||{{campaign.id}}&utm_medium={{adset.name}}||{{adset.id}}&utm_content={{ad.name}}||{{ad.id}}&utm_term={{site_source_name}}"
            },
            "account": {
              "email": "jsdcompanyscc@gmail.com"
            },
            "created_at": "2025-11-21T06:40:08+00:00"
          },
          "webhookUrl": "https://n8n.automscc.com/webhook/terence-blackfriday",
          "executionMode": "production"
        }
      }
    ]
  },
  "repo_name": "backupn8n",
  "repo_owner": "Santiagociroc11",
  "repo_path": "backup/",
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Bogota",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "shared": [
    {
      "updatedAt": "2025-11-21T21:00:45.466Z",
      "createdAt": "2025-11-21T21:00:45.466Z",
      "role": "workflow:owner",
      "workflowId": "U01F8eeHGvs3RI3z",
      "projectId": "703bt8e3CRxfBTYZ"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "updatedAt": "2025-02-04T22:36:35.108Z",
      "createdAt": "2025-02-04T22:36:35.108Z",
      "id": "HjNWwvqlBnseDfSA",
      "name": "GERSSON"
    },
    {
      "updatedAt": "2025-02-20T03:14:39.493Z",
      "createdAt": "2025-02-20T03:14:39.493Z",
      "id": "fMteddKWhaFhuYHk",
      "name": "MYSQL"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-11-21T21:17:36.000Z",
  "versionId": "08bafa64-7d4b-44fa-939d-3b2d306d9ee1"
}