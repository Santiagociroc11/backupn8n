{
  "active": true,
  "connections": {
    "Gmail Trigger": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Supabase",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-02-11T00:40:37.142Z",
  "id": "NtbkpXUWY5RAQ1tW",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "[BACKEND-AUTOFINANZAS] CORREOS Y TG",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "filters": {
          "includeSpamTrash": true,
          "sender": "alertasynotificaciones@notificacionesbancolombia.com"
        }
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.2,
      "position": [
        -720,
        -280
      ],
      "id": "473dfcf8-0cb3-44f0-8155-24b28d2eb69b",
      "name": "Gmail Trigger",
      "credentials": {
        "gmailOAuth2": {
          "id": "DOPWTzPin0EZKjQY",
          "name": "GMAIL SANTIAGO"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8a09502d-cbfd-437a-ae53-96089ceb6cc4",
              "name": "correo",
              "value": "={{ $json.snippet }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -480,
        -280
      ],
      "id": "ffc2b0b7-55a0-4bd9-be24-74320b63dd9a",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "jsCode": "const email = $input.first().json.correo;\n\n// Definir expresiones regulares robustas y tolerantes\nconst amountRegex = /\\$([\\d,.]+)/;\nconst dateRegex = /(\\d{2}\\/\\d{2}\\/\\d{4})/;\nconst timeRegex = /a las (\\d{2}:\\d{2})/;\nconst cuentaOrigenRegex = /desde .*?cuenta\\s*(\\*\\d+)/;\nconst cuentaDestinoRegex = /a la cuenta (\\*\\d+)/;\nconst empresaRegex = /en ([A-Z0-9\\s]+)/;\nconst facturaRegex = /Factura Programada ([A-Za-z\\s]+) Ref/;\nconst bancoDestinoRegex = /a ([A-Z\\s]+) desde/;\n\n// Extraer valores\nconst amountMatch = email.match(amountRegex);\nconst dateMatch = email.match(dateRegex);\nconst timeMatch = email.match(timeRegex);\nconst cuentaOrigenMatch = email.match(cuentaOrigenRegex);\nconst cuentaDestinoMatch = email.match(cuentaDestinoRegex);\nconst empresaMatch = email.match(empresaRegex);\nconst facturaMatch = email.match(facturaRegex);\nconst bancoDestinoMatch = email.match(bancoDestinoRegex);\n\n// Procesar valores\nconst amount = amountMatch ? parseFloat(amountMatch[1].replace(/,/g, \"\")) : null;\nconst dateExtracted = dateMatch ? dateMatch[1] : null;\nconst timeExtracted = timeMatch ? timeMatch[1] : \"00:00\";\nconst transactionDate = dateExtracted ? `${dateExtracted.split('/').reverse().join('-')} ${timeExtracted}:00-05` : null;\nconst cuentaOrigen = cuentaOrigenMatch ? cuentaOrigenMatch[1] : \"No encontrada\";\nconst cuentaDestino = cuentaDestinoMatch ? cuentaDestinoMatch[1] : \"No encontrada\";\nconst empresa = empresaMatch ? empresaMatch[1] : null;\nconst factura = facturaMatch ? facturaMatch[1] : null;\nconst bancoDestino = bancoDestinoMatch ? bancoDestinoMatch[1] : null;\n\n// Detectar tipo\nlet transactionType = \"otros\";\nlet description = email;\n\nif (email.includes(\"Transferiste\")) {\n  transactionType = \"transferencia\";\n  description = `Transferencia desde ${cuentaOrigen} a ${cuentaDestino}`;\n} else if (email.includes(\"Compraste\")) {\n  transactionType = \"compra con tarjeta\";\n  description = `Compra en ${empresa} con tarjeta ${cuentaOrigen}`;\n} else if (email.includes(\"Pagaste\")) {\n  transactionType = \"pago por pse\";\n  description = `Pago por PSE a ${bancoDestino} desde ${cuentaOrigen}`;\n} else if (email.includes(\"Factura Programada\")) {\n  transactionType = \"pago programado\";\n  description = `Pago programado de ${factura} desde ${cuentaOrigen}`;\n}\n\n// Devolver valores listos para base de datos\nreturn [{\n  values: {\n    amount,\n    description,\n    transaction_date: transactionDate,\n    transaction_type: transactionType,\n    type: \"gasto\"\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -260,
        -280
      ],
      "id": "38c47266-a959-4bed-8c40-1e1c4f3441e7",
      "name": "Code"
    },
    {
      "parameters": {
        "tableId": "transactions",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "amount",
              "fieldValue": "={{ $json.values.amount }}"
            },
            {
              "fieldId": "description",
              "fieldValue": "={{ $json.values.description }}"
            },
            {
              "fieldId": "transaction_date",
              "fieldValue": "={{ $json.values.transaction_date }}"
            },
            {
              "fieldId": "transaction_type",
              "fieldValue": "={{ $json.values.transaction_type }}"
            },
            {
              "fieldId": "type",
              "fieldValue": "={{ $json.values.type }}"
            },
            {
              "fieldId": "notification_email",
              "fieldValue": "={{ $('Gmail Trigger').item.json.To }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -20,
        -220
      ],
      "id": "7a6b257e-7184-4e16-9edb-5063633cd014",
      "name": "Supabase",
      "credentials": {
        "supabaseApi": {
          "id": "hekxcEm0GzZoyhoO",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "552780004",
        "text": "=⚡ *NUEVO MOVIMIENTO DETECTADO EN BANCOLOMBIA*\n\nSe acaba de registrar un nuevo movimiento con estos datos:\n\n*VALOR*: ${{ $json.values.amount.format() }}\n*DESCRIPCIÓN*: {{ $json.values.description }}\n*TIPO*: {{ $json.values.transaction_type }}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "REPORTAR TRANSACCIÓN",
                    "additionalFields": {
                      "url": "https://auto-finanzas.automscc.com/"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -20,
        -420
      ],
      "id": "ed45b8da-f16b-4291-a114-8d943ab3d24d",
      "name": "Telegram",
      "webhookId": "709cc4b4-8ba5-428c-8b5d-0b00c99b23d5",
      "credentials": {
        "telegramApi": {
          "id": "D5fwEGb7XJShZzzS",
          "name": "BOT FINANZAS"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "*"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -720,
        40
      ],
      "id": "78e8f12d-4788-4754-a8c3-a499876cf7ff",
      "name": "Telegram Trigger",
      "webhookId": "2c327f70-6d3f-4b8f-ae6a-5001c1db4833",
      "credentials": {
        "telegramApi": {
          "id": "D5fwEGb7XJShZzzS",
          "name": "BOT FINANZAS"
        }
      },
      "disabled": true
    }
  ],
  "pinData": {
    "Gmail Trigger": [
      {
        "json": {
          "id": "195b629e9afafce5",
          "threadId": "195b4c2ccc8f267b",
          "snippet": "¡Listo! Todo salió bien con tus movimientos Bancolombia: Transferiste $1000.00 desde tu cuenta *6138 a la cuenta *0000003009937799 el 20/03/2025 a las 19:45. ¿Dudas? Llamanos al 018000931987. Estamos",
          "payload": {
            "mimeType": "text/html"
          },
          "sizeEstimate": 51976,
          "historyId": "6711812",
          "internalDate": "1742517953000",
          "labels": [
            {
              "id": "INBOX",
              "name": "INBOX"
            },
            {
              "id": "CATEGORY_UPDATES",
              "name": "CATEGORY_UPDATES"
            },
            {
              "id": "UNREAD",
              "name": "UNREAD"
            }
          ],
          "From": "Alertas y Notificaciones <alertasynotificaciones@notificacionesbancolombia.com>",
          "Subject": "Alertas y Notificaciones",
          "To": "santiagociiro12@gmail.com"
        }
      }
    ]
  },
  "repo_name": "backupn8n",
  "repo_owner": "Santiagociroc11",
  "repo_path": "backup/",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "node:Gmail Trigger": {
      "Gmail Trigger": {
        "lastTimeChecked": 1742531928,
        "possibleDuplicates": [
          "195b6ff238636228"
        ]
      }
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-03-21T04:47:54.000Z",
  "versionId": "c416b42d-bf0e-4e9b-8297-7f43b553d7c5"
}